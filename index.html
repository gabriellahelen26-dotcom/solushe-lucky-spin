<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Solushe Lucky Spin</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@1&display=swap" rel="stylesheet">

<style>
  :root{
    --maroon:#7a1f2b;
    --white:#ffffff;
    --gold:#d4af37;
    --bright-red:#ff0000;
  }

  html,body{
    margin:0; padding:0;
    width:100%; height:100%;
    overflow:hidden;
    font-family:Arial,sans-serif;
  }

  body{
    background:url("background.jpg") center/cover no-repeat fixed;
  }

  /* 1️⃣ TITLE (PLAIN, STABIL, NO SHADOW/GRADIENT) */
  #title{
    position:fixed;
    top:18px;
    left:0;
    width:100%;
    text-align:center;
    font-family:"Playfair Display", serif;
    font-style:italic;
    font-weight:700;
    font-size:56px;
    color:var(--maroon);
    z-index:1000;
    pointer-events:none;
    text-shadow:none;
    background:transparent;
  }

  /* ✅ Hidden Admin Hotspot (tap/click untuk iPad/Tab) */
  #adminHotspot{
    position:fixed;
    top:0;
    left:0;
    width:44px;
    height:44px;
    background:transparent;
    z-index:1500;
  }

  /* ✅ Fullscreen toggle hotspot di kanan atas */
  #fullscreenHotspot{
    position:fixed;
    top:0;
    right:0;
    width:44px;
    height:44px;
    background:transparent;
    z-index:1500;
  }

  /* CENTER (turunin sedikit biar tidak nabrak judul) */
  #center{
    position:absolute;
    inset:0;
    display:flex;
    justify-content:center;
    align-items:center;
    padding-top:65px;
    box-sizing:border-box;
  }

  #wheel-wrap{
    position:relative;
    width:460px;
    height:460px;
  }

  /* ✅ NEW: wrapper khusus wheel (biar tombol SPIN gak ikut naik) */
  #wheel-stage{
    position:relative;
    width:100%;
    height:100%;
    transform:translateY(-25px); /* ✅ naikkan wheel aja (ubah angka ini kalau mau) */
  }

  /* 5️⃣ GOLD RING (DIAM, LUAR WHEEL) */
  #gold-ring{
    position:absolute;
    inset:-24px;
    background:url("gold-ring.png") center/contain no-repeat;
    pointer-events:none;
    z-index:1;
  }

  /* Wheel canvas (yang diputar hanya ini) */
  #wheel{
    width:100%;
    height:100%;
    border-radius:50%;
    background:var(--white);
    position:relative;
    z-index:2;
    transform:rotate(0deg);
    will-change:transform;
  }

  /* 6️⃣ LOGO (BULAT, BERSIH, TANPA RING, DIAM) */
  #logo{
    position:absolute;
    width:90px;
    height:90px;
    border-radius:50%;
    object-fit:cover;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:6;
    background:transparent;
    pointer-events:none;
  }

  /* 2️⃣ POINTER */
  #pointer{
    position:absolute;
    top:50%;
    left:100%;
    transform:translate(-10px, -50%);
    width:0; height:0;
    border-top:16px solid transparent;
    border-bottom:16px solid transparent;
    border-right:34px solid var(--bright-red);
    z-index:7;
    pointer-events:none;
  }

  .pointer-bounce{
    animation:pointerClick .12s ease;
  }
  @keyframes pointerClick{
    0%   { transform:translate(-10px,-50%); }
    50%  { transform:translate(-16px,-50%); }
    100% { transform:translate(-10px,-50%); }
  }

  #spin{
    position:absolute;
    bottom:-80px;
    left:50%;
    transform:translateX(-50%);
    padding:14px 40px;
    font-size:22px;
    font-weight:bold;
    border:none;
    border-radius:30px;
    background:maroon;
    color:white;
    cursor:pointer;
    z-index:10;
  }
  #spin:disabled{ opacity:.6; cursor:not-allowed; }

  #overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.65);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
  }
  #winText{
    font-size:54px;
    font-weight:bold;
    color:white;
    text-align:center;
    text-shadow:
      0 0 12px rgba(255,230,150,.9),
      0 0 26px rgba(255,230,150,.75);
    transform:scale(.85);
    opacity:0;
  }
  .win-zoom{
    animation:winZoom .35s ease forwards;
  }
  @keyframes winZoom{
    to{ transform:scale(1); opacity:1; }
  }

  .confetti{
    position:fixed;
    width:10px;
    height:14px;
    left:var(--sx);
    top:var(--sy);
    background:var(--c);
    opacity:1;
    transform:translate(0,0) rotate(0deg);
    animation:confettiExplode 2.8s ease-out forwards;
    z-index:1999;
    pointer-events:none;
  }
  @keyframes confettiExplode{
    to{
      transform:translate(var(--dx), var(--dy)) rotate(720deg);
      opacity:0;
    }
  }

  #admin{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:3000;
  }
  #adminPanel{
    width:min(760px, 92vw);
    max-height:min(80vh, 720px);
    background:white;
    border-radius:14px;
    padding:18px 18px 14px;
    overflow:auto;
    position:relative;
    box-shadow:0 12px 40px rgba(0,0,0,.35);
  }
  #adminPanel h2{ margin:0 0 10px 0; }
  #closeAdmin{
    position:absolute;
    top:12px;
    right:14px;
    font-size:16px;
    cursor:pointer;
    font-weight:bold;
    background:#f2f2f2;
    border-radius:10px;
    padding:8px 12px;
    user-select:none;
  }
  .adminRow{
    display:flex;
    gap:10px;
    align-items:center;
    padding:8px 0;
    border-bottom:1px solid #eee;
  }
  .adminName{ flex:1; font-weight:700; }
  .adminChance input{ width:90px; padding:6px 8px; }
  #adminLog{
    margin-top:14px;
    padding-top:10px;
    border-top:2px dashed #ddd;
  }
  #adminLogList{
    font-family:Arial, sans-serif;
    font-size:14px;
    line-height:1.45;
    max-height:220px;
    overflow:auto;
    background:#fafafa;
    border:1px solid #eee;
    border-radius:10px;
    padding:10px;
  }
</style>
</head>

<body>

<div id="adminHotspot" aria-label="Admin Hotspot"></div>
<div id="fullscreenHotspot" aria-label="Fullscreen Toggle Hotspot"></div>

<div id="title">Solushe Lucky Spin</div>

<div id="center">
  <div id="wheel-wrap">

    <!-- ✅ wheel-only stage (yang naik cuma ini) -->
    <div id="wheel-stage">
      <div id="gold-ring"></div>
      <canvas id="wheel" width="460" height="460"></canvas>
      <img src="logo.png" id="logo" alt="logo">
      <div id="pointer"></div>
    </div>

    <!-- ✅ tombol tetap posisi awal -->
    <button id="spin">SPIN</button>
  </div>
</div>

<div id="overlay"><div id="winText"></div></div>

<div id="admin">
  <div id="adminPanel">
    <div id="closeAdmin">OK / CLOSE ✕</div>
    <h2>Admin Mode</h2>
    <div id="adminList"></div>

    <div id="adminLog">
      <h3 style="margin:10px 0 8px 0;">Log Hasil Spin</h3>
      <div id="adminLogList"></div>
      <div style="margin-top:10px; font-size:12px; color:#666;">
        Shortcut: <b>CTRL + ALT + A</b> untuk buka / tutup.
      </div>

      <div style="margin-top:10px;">
        <button id="exportLog" style="padding:10px 14px; border:none; border-radius:10px; background:#2f7d32; color:white; font-weight:bold; cursor:pointer;">
          EXPORT LOG ke Excel
        </button>
        <button id="resetAll" style="margin-left:8px; padding:10px 14px; border:none; border-radius:10px; background:#b71c1c; color:white; font-weight:bold; cursor:pointer;">
          RESET KE SETTING AWAL
        </button>
      </div>
    </div>
  </div>
</div>

<audio id="drum" src="drumroll.mp3" preload="auto"></audio>
<audio id="win" src="win.mp3" preload="auto"></audio>

<script>
const DEFAULT_PRIZES = [
  { name:"iPhone 17 Pro", chance:0, once:true },
  { name:"MMFU", chance:10 },
  { name:"Philips Air Fryer", chance:1, once:true },
  { name:"Face / Acne\nRejuve", chance:30 },
  { name:"Remington Hair\nStraightener", chance:1, once:true },
  { name:"Underarm Rejuve /\nHair Removal", chance:30 },
  { name:"Glow / Acne Peel", chance:40 },
  { name:"Logam Mulia", chance:1, once:true }
];

const STORAGE_KEY = "solushe_lucky_spin_state_v1";

function safeParseJSON(s){ try{ return JSON.parse(s); }catch(e){ return null; } }

function normalizePrizes(arr){
  if(!Array.isArray(arr)) return null;
  const out = [];
  for(const p of arr){
    if(!p || typeof p !== "object") continue;
    if(typeof p.name !== "string") continue;
    out.push({ name:p.name, chance:Number(p.chance||0), ...(p.once?{once:true}:{}) });
  }
  return out.length ? out : null;
}

function normalizeLogs(arr){
  if(!Array.isArray(arr)) return [];
  return arr.map(x => String(x)).filter(Boolean);
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return null;
  const st = safeParseJSON(raw);
  if(!st || typeof st !== "object") return null;

  const loadedPrizes = normalizePrizes(st.prizes);
  const loadedLogs = normalizeLogs(st.spinLogs);
  const loadedAngle = Number(st.angle || 0);

  return {
    prizes: loadedPrizes,
    spinLogs: loadedLogs,
    angle: isFinite(loadedAngle) ? loadedAngle : 0
  };
}

function saveState(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ prizes, spinLogs, angle }));
  }catch(e){}
}

let prizes = DEFAULT_PRIZES.map(p => ({...p}));
let spinLogs = [];
let spinning = false;
let rafId = null;
let angle = 0;

const loaded = loadState();
if(loaded){
  if(loaded.prizes) prizes = loaded.prizes;
  spinLogs = loaded.spinLogs || [];
  angle = loaded.angle || 0;
}

const maroon = getComputedStyle(document.documentElement).getPropertyValue('--maroon').trim() || "#7a1f2b";
const white  = getComputedStyle(document.documentElement).getPropertyValue('--white').trim()  || "#ffffff";

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

const wheelEl = document.getElementById("wheel");
const spinBtn = document.getElementById("spin");
const pointerEl = document.getElementById("pointer");

const overlay = document.getElementById("overlay");
const winText = document.getElementById("winText");

const drum = document.getElementById("drum");
const winSfx = document.getElementById("win");

wheelEl.style.transform = `rotate(${angle}deg)`;

/* ✅ DRAW (text menjorok + border gold antar slice) */
function draw(){
  ctx.clearRect(0,0,460,460);
  const cx=230, cy=230, r=230;

  const arc = (Math.PI*2) / prizes.length;

  prizes.forEach((p,i)=>{
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.fillStyle = (i%2) ? maroon : white;
    ctx.arc(cx,cy,r, i*arc, (i+1)*arc);
    ctx.closePath();
    ctx.fill();

    // ✅ border gold antar slice
    ctx.strokeStyle = "#d4af37";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Text
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(i*arc + arc/2);

    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    ctx.fillStyle = (i%2) ? white : maroon;
    ctx.font = "bold 17px Arial";

    const lines = p.name.split("\n").slice(0,2);
    const lineH = 18;

    // ✅ text menjorok ke dalam
    const textRadius = p.name.includes("Underarm Rejuve") ? 215 : 205;

    const totalH = (lines.length-1)*lineH;
    lines.forEach((line, idx)=>{
      const y = (idx*lineH) - (totalH/2);
      ctx.fillText(line, textRadius, y);
    });

    ctx.restore();
  });
}
draw();

function pickPrize(){
  const total = prizes.reduce((s,p)=> s + Number(p.chance||0), 0);
  let r = Math.random() * total;
  for(const p of prizes){
    const c = Number(p.chance||0);
    if(r < c) return p;
    r -= c;
  }
  return prizes[prizes.length-1];
}

function cancelSpinIfAny(){
  if(rafId){
    cancelAnimationFrame(rafId);
    rafId = null;
  }
}

function pointerClick(){
  pointerEl.classList.remove("pointer-bounce");
  void pointerEl.offsetWidth;
  pointerEl.classList.add("pointer-bounce");
}

function pointerClickTriple(){
  let n=0;
  const tick = ()=>{
    pointerClick();
    n++;
    if(n<3) setTimeout(tick, 140);
  };
  tick();
}

let spinPhase = "idle";
let selectedPrize = null;
let selectedIndex = -1;
let spinLastTime = null;

const FREE_SPIN_SPEED_DEG_PER_MS = 0.55;

function startFreeSpin(){
  try{
    drum.pause(); drum.currentTime = 0;
    winSfx.pause(); winSfx.currentTime = 0;
  }catch(e){}

  try{ drum.loop = true; }catch(e){}
  drum.play().catch(()=>{});

  spinPhase = "spinning";
  spinBtn.textContent = "STOP";
  spinBtn.disabled = false;

  spinLastTime = null;

  const speedDegPerMs = FREE_SPIN_SPEED_DEG_PER_MS;

  function animate(t){
    if(spinPhase !== "spinning") return;
    if(!spinLastTime) spinLastTime = t;
    const dt = t - spinLastTime;
    spinLastTime = t;

    angle = angle + (speedDegPerMs * dt);
    wheelEl.style.transform = `rotate(${angle}deg)`;

    rafId = requestAnimationFrame(animate);
  }

  rafId = requestAnimationFrame(animate);
}

function stopToSelectedPrize(){
  if(spinPhase !== "spinning") return;

  spinPhase = "stopping";
  spinBtn.disabled = true;
  cancelSpinIfAny();

  const winPrize = selectedPrize;
  const idx = selectedIndex;

  const sliceDeg = 360 / prizes.length;

  // ✅ stop random dalam slice + margin sangat kecil (hampir salah slice)
  const sliceStart = idx * sliceDeg;
  const sliceEnd   = (idx + 1) * sliceDeg;

  let margin = Math.min(sliceDeg * 0.02, 1.5);
  margin = Math.min(margin, sliceDeg / 2 - 0.01);

  const stopTheta =
    (sliceStart + margin) +
    Math.random() * ((sliceEnd - margin) - (sliceStart + margin));

  const startAngle = angle;
  const extraTurns = 3 * 360;

  const base = Math.ceil(startAngle/360) * 360;
  let targetAngle = base + extraTurns + (360 - stopTheta);
  if(targetAngle <= startAngle + 360){
    targetAngle += 360;
  }

  const D = (targetAngle - startAngle);
  const v0 = Math.max(0.15, FREE_SPIN_SPEED_DEG_PER_MS);
  let duration = (2 * D) / v0;

  if(duration < 1600) duration = 1600;
  if(duration > 6500) duration = 6500;

  const a = -v0 / duration;

  let startTime = null;

  function animate(t){
    if(!startTime) startTime = t;
    const elapsed = t - startTime;
    const tt = Math.min(elapsed, duration);

    const current = startAngle + (v0 * tt) + (0.5 * a * tt * tt);

    angle = current;
    wheelEl.style.transform = `rotate(${angle}deg)`;

    if(elapsed < duration){
      rafId = requestAnimationFrame(animate);
    }else{
      rafId = null;
      angle = targetAngle;
      wheelEl.style.transform = `rotate(${angle}deg)`;
      finishSpin(winPrize);
    }
  }

  rafId = requestAnimationFrame(animate);
}

spinBtn.addEventListener("click", ()=>{
  if(spinPhase === "idle"){
    if(spinning) return;

    spinning = true;
    cancelSpinIfAny();

    selectedPrize = pickPrize();
    selectedIndex = prizes.indexOf(selectedPrize);

    startFreeSpin();
    return;
  }

  if(spinPhase === "spinning"){
    stopToSelectedPrize();
    return;
  }

  if(spinPhase === "stopping"){
    return;
  }
});

function finishSpin(winPrize){
  try{
    drum.loop = false;
    drum.pause();
  }catch(e){}
  winSfx.play().catch(()=>{});

  pointerClickTriple();

  winText.classList.remove("win-zoom");
  winText.innerText = winPrize.name.replace("\n"," ");
  overlay.style.display = "flex";
  void winText.offsetWidth;
  winText.classList.add("win-zoom");

  confettiExplode();

  addLog(winPrize.name.replace("\n"," "));

  if(winPrize.once){
    prizes = prizes.filter(p => p !== winPrize);
    draw();
  }

  saveState();

  spinning = false;
  spinPhase = "idle";
  selectedPrize = null;
  selectedIndex = -1;
  spinLastTime = null;

  spinBtn.disabled = false;
  spinBtn.textContent = "SPIN";
}

overlay.addEventListener("click", ()=>{ overlay.style.display = "none"; });

function confettiExplode(){
  const colors = [ "#ffffff", maroon, "#d4af37" ];
  const sx = "50vw";
  const sy = "55vh";
  const count = 260;

  for(let i=0;i<count;i++){
    const c = document.createElement("div");
    c.className = "confetti";
    c.style.setProperty("--sx", sx);
    c.style.setProperty("--sy", sy);
    c.style.setProperty("--c", colors[Math.floor(Math.random()*colors.length)]);

    const a = Math.random() * Math.PI * 2;
    const dist = 120 + Math.random() * 520;
    const dx = Math.cos(a) * dist;
    const dy = Math.sin(a) * dist;

    c.style.setProperty("--dx", dx.toFixed(1) + "px");
    c.style.setProperty("--dy", dy.toFixed(1) + "px");

    const jitterX = (Math.random()*10 - 5);
    const jitterY = (Math.random()*10 - 5);
    c.style.left = `calc(50vw + ${jitterX}px)`;
    c.style.top  = `calc(55vh + ${jitterY}px)`;

    document.body.appendChild(c);
    setTimeout(()=> c.remove(), 3200);
  }
}

const admin = document.getElementById("admin");
const adminList = document.getElementById("adminList");
const adminLogList = document.getElementById("adminLogList");
const closeAdmin = document.getElementById("closeAdmin");

function exportLogToExcel(){
  const header = ["Tanggal & Waktu","Hadiah"];
  const rows = [header];
  const ordered = spinLogs.slice().reverse();

  for(const entry of ordered){
    const parts = String(entry).split(" — ");
    const tanggal = parts[0] || "";
    const hadiah = parts.slice(1).join(" — ") || "";
    rows.push([tanggal, hadiah]);
  }

  function csvEscape(v){
    v = String(v ?? "");
    v = v.replaceAll("\r\n","\n").replaceAll("\r","\n");
    if(v.includes('"')) v = v.replaceAll('"','""');
    if(v.includes(",") || v.includes("\n") || v.includes('"')) v = `"${v}"`;
    return v;
  }

  const csv = rows.map(r => r.map(csvEscape).join(",")).join("\r\n");
  const blob = new Blob(["\uFEFF" + csv], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  const fname = `solushe-spin-log-${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}.csv`;

  const a = document.createElement("a");
  a.href = url;
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(()=> URL.revokeObjectURL(url), 1200);
}

function resetAllToDefault(){
  const ok = confirm("Reset SEMUA data ke setting awal? (log + chance + hadiah once + posisi wheel akan kembali default)");
  if(!ok) return;

  prizes = DEFAULT_PRIZES.map(p => ({...p}));
  spinLogs = [];
  angle = 0;

  wheelEl.style.transform = `rotate(${angle}deg)`;
  draw();
  renderLog();
  renderAdmin();

  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  saveState();
}

function addLog(text){
  const stamp = new Date().toLocaleString("id-ID");
  spinLogs.unshift(`${stamp} — ${text}`);
  renderLog();
  saveState();
}

function renderLog(){
  if(spinLogs.length===0){
    adminLogList.innerHTML = "<i>Belum ada spin.</i>";
    return;
  }
  adminLogList.innerHTML = spinLogs.map(x => `• ${escapeHtml(x)}`).join("<br>");
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderAdmin(){
  adminList.innerHTML = "";
  prizes.forEach((p,i)=>{
    const row = document.createElement("div");
    row.className = "adminRow";

    const nm = document.createElement("div");
    nm.className = "adminName";
    nm.textContent = p.name.replace("\n"," ");

    const ch = document.createElement("div");
    ch.className = "adminChance";
    ch.innerHTML = `Chance (%): <input type="number" min="0" step="1" value="${Number(p.chance||0)}">`;

    const input = ch.querySelector("input");
    input.addEventListener("input", ()=>{
      prizes[i].chance = Number(input.value || 0);
      saveState();
    });

    row.appendChild(nm);
    row.appendChild(ch);
    adminList.appendChild(row);
  });

  renderLog();
}

document.addEventListener("keydown", (e)=>{
  if(e.ctrlKey && e.altKey && e.key.toLowerCase()==="a"){
    admin.style.display = (admin.style.display==="flex") ? "none" : "flex";
    if(admin.style.display==="flex") renderAdmin();
    saveState();
  }
});

closeAdmin.addEventListener("click", ()=>{
  admin.style.display = "none";
  saveState();
});

document.getElementById("adminHotspot").addEventListener("click", ()=>{
  admin.style.display = (admin.style.display==="flex") ? "none" : "flex";
  if(admin.style.display==="flex") renderAdmin();
  saveState();
});

document.getElementById("fullscreenHotspot").addEventListener("click", ()=>{
  if (document.fullscreenElement) document.exitFullscreen();
  else document.documentElement.requestFullscreen();
});

document.getElementById("exportLog").addEventListener("click", ()=>{ exportLogToExcel(); });
document.getElementById("resetAll").addEventListener("click", ()=>{ resetAllToDefault(); });
</script>
</body>
</html>
