<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Solushe Lucky Spin</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@1&display=swap" rel="stylesheet">

<style>
  :root{
    --maroon:#7a1f2b;
    --white:#ffffff;
    --gold:#d4af37;
    --bright-red:#ff0000;
  }

  html,body{
    margin:0; padding:0;
    width:100%; height:100%;
    overflow:hidden;
    font-family:Arial,sans-serif;
  }

  /* ✅ BACKGROUND FIX: selalu penuh di semua device + area kosong jadi blur (tanpa putih) */
  body{
    position:relative;
    background:#e9e3da; /* fallback biar tidak pernah putih */
    min-height:100svh;
    min-height:100dvh;
    min-height:100vh;
    min-height:-webkit-fill-available;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:url("background.jpg") center/cover no-repeat;
    z-index:-2;
    transform:translateZ(0);
    backface-visibility:hidden;
    will-change:transform;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background:url("background.jpg") center/contain no-repeat;
    filter:blur(18px);
    transform:scale(1.12) translateZ(0);
    opacity:.55;
    z-index:-1;
    transform-origin:center;
    pointer-events:none;
    backface-visibility:hidden;
    will-change:transform;
  }

  /* 1️⃣ TITLE */
  #title{
    position:fixed;
    top:18px;
    left:0;
    width:100%;
    text-align:center;
    font-family:"Playfair Display", serif;
    font-style:italic;
    font-weight:700;
    font-size:56px;
    color:var(--maroon);
    z-index:1000;
    pointer-events:none;
    text-shadow:none;
    background:transparent;
  }

  /* ✅ Hidden Admin Hotspot (tap/click untuk iPad/Tab) */
  #adminHotspot{
    position:fixed;
    top:0;
    left:0;
    width:44px;
    height:44px;
    background:transparent;
    z-index:1500;
  }

  /* ✅ Fullscreen toggle hotspot di kanan atas */
  #fullscreenHotspot{
    position:fixed;
    top:0;
    right:0;
    width:44px;
    height:44px;
    background:transparent;
    z-index:1500;
  }

  /* CENTER */
  #center{
    position:absolute;
    inset:0;
    display:flex;
    justify-content:center;
    align-items:center;
    padding-top:65px;

    /* ✅ penting: kasih ruang aman bawah supaya tombol yang "keluar" (bottom:-80px)
       tidak kepotong sama batas viewport (iPad fullscreen landscape). */
    padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 14px);

    box-sizing:border-box;
    height: calc(var(--vh, 1vh) * 100); /* iOS fix */
  }

  /* ✅ FIX UTAMA: wheel otomatis mengecil kalau tinggi viewport kurang,
     TANPA mengubah posisi tombol (bottom:-80px tetap). */
  #wheel-wrap{
    position:relative;

    /* Buffer aman: title + naik wheel (-25) + tombol keluar (-80) + margin */
    --safeH: calc((var(--vh, 1vh) * 100) - 330px);

    width:  min(460px, 88vmin, var(--safeH));
    height: min(460px, 88vmin, var(--safeH));
    aspect-ratio:1 / 1;

    /* ✅ supaya overflow dari tombol bisa terlihat (jangan kepotong oleh parent) */
    overflow: visible;
  }

  /* wheel-only stage */
  #wheel-stage{
    position:relative;
    width:100%;
    height:100%;
    transform:translateY(-25px); /* TETAP */
  }

  /* GOLD RING */
  #gold-ring{
    position:absolute;
    inset:-24px;
    background:url("gold-ring.png") center/contain no-repeat;
    pointer-events:none;
    z-index:1;
  }

  /* Wheel canvas */
  #wheel{
    width:100%;
    height:100%;
    border-radius:50%;
    background:var(--white);
    position:relative;
    z-index:2;
    transform:rotate(0deg);
    will-change:transform;
    display:block;
  }

  /* LOGO */
  #logo{
    position:absolute;
    width:90px;
    height:90px;
    border-radius:50%;
    object-fit:cover;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:6;
    background:transparent;
    pointer-events:none;
  }

  /* POINTER */
  #pointer{
    position:absolute;
    top:50%;
    left:100%;
    transform:translate(-10px, -50%);
    width:0; height:0;
    border-top:16px solid transparent;
    border-bottom:16px solid transparent;
    border-right:34px solid var(--bright-red);
    z-index:7;
    pointer-events:none;
  }

  .pointer-bounce{ animation:pointerClick .12s ease; }
  @keyframes pointerClick{
    0%   { transform:translate(-10px,-50%); }
    50%  { transform:translate(-16px,-50%); }
    100% { transform:translate(-10px,-50%); }
  }

  /* ✅ TOMBOL: POSISI TETAP (sesuai permintaan) + selalu layer atas */
  #spin{
    position:absolute;
    bottom:-80px;            /* TETAP */
    left:50%;
    transform:translateX(-50%);
    padding:14px 40px;
    font-size:22px;
    font-weight:bold;
    border:none;
    border-radius:30px;
    background:maroon;
    color:white;
    cursor:pointer;

    /* ✅ bikin pasti ga ketutup apa pun */
    z-index:9999;
    isolation:isolate;

    /* ✅ iOS Safari kadang “nge-clip” layer tertentu; ini bantu */
    translate: 0 0;
  }
  #spin:disabled{ opacity:.6; cursor:not-allowed; }

  #overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.65);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
  }
  #winText{
    font-size:54px;
    font-weight:bold;
    color:white;
    text-align:center;
    text-shadow:
      0 0 12px rgba(255,230,150,.9),
      0 0 26px rgba(255,230,150,.75);
    transform:scale(.85);
    opacity:0;
  }
  .win-zoom{ animation:winZoom .35s ease forwards; }
  @keyframes winZoom{ to{ transform:scale(1); opacity:1; } }

  .confetti{
    position:fixed;
    width:10px;
    height:14px;
    left:var(--sx);
    top:var(--sy);
    background:var(--c);
    opacity:1;
    transform:translate(0,0) rotate(0deg);
    animation:confettiExplode 2.8s ease-out forwards;
    z-index:1999;
    pointer-events:none;
  }
  @keyframes confettiExplode{
    to{ transform:translate(var(--dx), var(--dy)) rotate(720deg); opacity:0; }
  }

  #admin{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:3000;
  }
  #adminPanel{
    width:min(760px, 92vw);
    max-height:min(80vh, 720px);
    background:white;
    border-radius:14px;
    padding:18px 18px 14px;
    overflow:auto;
    position:relative;
    box-shadow:0 12px 40px rgba(0,0,0,.35);
  }
  #adminPanel h2{ margin:0 0 10px 0; }
  #closeAdmin{
    position:absolute;
    top:12px;
    right:14px;
    font-size:16px;
    cursor:pointer;
    font-weight:bold;
    background:#f2f2f2;
    border-radius:10px;
    padding:8px 12px;
    user-select:none;
  }
  .adminRow{
    display:flex;
    gap:10px;
    align-items:center;
    padding:8px 0;
    border-bottom:1px solid #eee;
  }
  .adminName{ flex:1; font-weight:700; }
  .adminChance input{ width:90px; padding:6px 8px; }
  #adminLog{
    margin-top:14px;
    padding-top:10px;
    border-top:2px dashed #ddd;
  }
  #adminLogList{
    font-family:Arial, sans-serif;
    font-size:14px;
    line-height:1.45;
    max-height:220px;
    overflow:auto;
    background:#fafafa;
    border:1px solid #eee;
    border-radius:10px;
    padding:10px;
  }
</style>
</head>

<body>
<div id="adminHotspot" aria-label="Admin Hotspot"></div>
<div id="fullscreenHotspot" aria-label="Fullscreen Toggle Hotspot"></div>

<div id="title">Solushe Lucky Spin</div>

<div id="center">
  <div id="wheel-wrap">
    <div id="wheel-stage">
      <div id="gold-ring"></div>
      <canvas id="wheel" width="460" height="460"></canvas>
      <img src="logo.png" id="logo" alt="logo">
      <div id="pointer"></div>
    </div>

    <button id="spin">SPIN</button>
  </div>
</div>

<div id="overlay"><div id="winText"></div></div>

<div id="admin">
  <div id="adminPanel">
    <div id="closeAdmin">OK / CLOSE ✕</div>
    <h2>Admin Mode</h2>
    <div id="adminList"></div>

    <div id="adminLog">
      <h3 style="margin:10px 0 8px 0;">Log Hasil Spin</h3>
      <div id="adminLogList"></div>
      <div style="margin-top:10px; font-size:12px; color:#666;">
        Shortcut: <b>CTRL + ALT + A</b> untuk buka / tutup.
      </div>

      <div style="margin-top:10px;">
        <button id="exportLog" style="padding:10px 14px; border:none; border-radius:10px; background:#2f7d32; color:white; font-weight:bold; cursor:pointer;">
          EXPORT LOG ke Excel
        </button>
        <button id="resetAll" style="margin-left:8px; padding:10px 14px; border:none; border-radius:10px; background:#b71c1c; color:white; font-weight:bold; cursor:pointer;">
          RESET KE SETTING AWAL
        </button>
      </div>
    </div>
  </div>
</div>

<audio id="drum" src="drumroll.mp3" preload="auto"></audio>
<audio id="win" src="win.mp3" preload="auto"></audio>

<script>
/* ✅ iOS/iPad viewport height fix (anti putih saat fullscreen / address bar berubah) */
function setVh(){
  document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
}
setVh();
window.addEventListener('resize', setVh);
window.addEventListener('orientationchange', setVh);

const DEFAULT_PRIZES = [
  { name:"iPhone 17 Pro", chance:0, once:true },
  { name:"MMFU", chance:9 },
  { name:"Philips Air Fryer", chance:1, once:true },
  { name:"Face / Acne\nRejuve", chance:27 },
  { name:"Remington Hair\nStraightener", chance:1, once:true },
  { name:"Underarm Rejuve /\nHair Removal", chance:27 },
  { name:"Glow / Acne Peel", chance:34 },
  { name:"Logam Mulia", chance:1, once:true }
];

const STORAGE_KEY = "solushe_lucky_spin_state_v1";

function safeParseJSON(s){ try{ return JSON.parse(s); }catch(e){ return null; } }

function normalizePrizes(arr){
  if(!Array.isArray(arr)) return null;
  const out = [];
  for(const p of arr){
    if(!p || typeof p !== "object") continue;
    if(typeof p.name !== "string") continue;
    out.push({ name:p.name, chance:Number(p.chance||0), ...(p.once?{once:true}:{}) });
  }
  return out.length ? out : null;
}

function normalizeLogs(arr){
  if(!Array.isArray(arr)) return [];
  return arr.map(x => String(x)).filter(Boolean);
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return null;
  const st = safeParseJSON(raw);
  if(!st || typeof st !== "object") return null;

  const loadedPrizes = normalizePrizes(st.prizes);
  const loadedLogs = normalizeLogs(st.spinLogs);
  const loadedAngle = Number(st.angle || 0);

  return {
    prizes: loadedPrizes,
    spinLogs: loadedLogs,
    angle: isFinite(loadedAngle) ? loadedAngle : 0
  };
}

function saveState(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ prizes, spinLogs, angle }));
  }catch(e){}
}

let prizes = DEFAULT_PRIZES.map(p => ({...p}));
let spinLogs = [];
let spinning = false;
let rafId = null;
let angle = 0;

const loaded = loadState();
if(loaded){
  if(loaded.prizes) prizes = loaded.prizes;
  spinLogs = loaded.spinLogs || [];
  angle = loaded.angle || 0;
}

const maroon = getComputedStyle(document.documentElement).getPropertyValue('--maroon').trim() || "#7a1f2b";
const white  = getComputedStyle(document.documentElement).getPropertyValue('--white').trim()  || "#ffffff";

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

const wheelEl = document.getElementById("wheel");
const spinBtn = document.getElementById("spin");
const pointerEl = document.getElementById("pointer");

const overlay = document.getElementById("overlay");
const winText = document.getElementById("winText");

const drum = document.getElementById("drum");
const winSfx = document.getElementById("win");

wheelEl.style.transform = `rotate(${angle}deg)`;

/* ✅ DRAW (text menjorok + border gold antar slice) */
function draw(){
  ctx.clearRect(0,0,460,460);
  const cx=230, cy=230, r=230;

  if(!prizes.length){
    return;
  }

  const arc = (Math.PI*2) / prizes.length;

  prizes.forEach((p,i)=>{
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.fillStyle = (i%2) ? maroon : white;
    ctx.arc(cx,cy,r, i*arc, (i+1)*arc);
    ctx.closePath();
    ctx.fill();

    // ✅ border gold antar slice
    ctx.strokeStyle = "#d4af37";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Text
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(i*arc + arc/2);

    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    ctx.fillStyle = (i%2) ? white : maroon;
    ctx.font = "bold 17px Arial";

    const lines = p.name.split("\n").slice(0,2);
    const lineH = 18;

    // ✅ text menjorok ke dalam
    const textRadius = p.name.includes("Underarm Rejuve") ? 215 : 205;

    const totalH = (lines.length-1)*lineH;
    lines.forEach((line, idx)=>{
      const y = (idx*lineH) - (totalH/2);
      ctx.fillText(line, textRadius, y);
    });

    ctx.restore();
  });
}
draw();

function pickPrize(){
  const total = prizes.reduce((s,p)=> s + Number(p.chance||0), 0);
  let r = Math.random() * total;
  for(const p of prizes){
    const c = Number(p.chance||0);
    if(r < c) return p;
    r -= c;
  }
  return prizes[prizes.length-1];
}

function cancelSpinIfAny(){
  if(rafId){
    cancelAnimationFrame(rafId);
    rafId = null;
  }
}

function pointerClick(){
  pointerEl.classList.remove("pointer-bounce");
  void pointerEl.offsetWidth;
  pointerEl.classList.add("pointer-bounce");
}

function pointerClickTriple(){
  let n=0;
  const tick = ()=>{
    pointerClick();
    n++;
    if(n<3) setTimeout(tick, 140);
  };
  tick();
}

let spinPhase = "idle";
let selectedPrize = null;
let selectedIndex = -1;
let spinLastTime = null;

const FREE_SPIN_SPEED_DEG_PER_MS = 0.55;

function startFreeSpin(){
  try{
    drum.pause(); drum.currentTime = 0;
    winSfx.pause(); winSfx.currentTime = 0;
  }catch(e){}

  try{ drum.loop = true; }catch(e){}
  drum.play().catch(()=>{});

  spinPhase = "spinning";
  spinBtn.textContent = "STOP";
  spinBtn.disabled = false;

  spinLastTime = null;

  const speedDegPerMs = FREE_SPIN_SPEED_DEG_PER_MS;

  function animate(t){
    if(spinPhase !== "spinning") return;
    if(!spinLastTime) spinLastTime = t;
    const dt = t - spinLastTime;
    spinLastTime = t;

    angle = angle + (speedDegPerMs * dt);
    wheelEl.style.transform = `rotate(${angle}deg)`;

    rafId = requestAnimationFrame(animate);
  }

  rafId = requestAnimationFrame(animate);
}

function stopToSelectedPrize(){
  if(spinPhase !== "spinning") return;

  spinPhase = "stopping";
  spinBtn.disabled = true;
  cancelSpinIfAny();

  const winPrize = selectedPrize;
  const idx = selectedIndex;

  const sliceDeg = 360 / prizes.length;

  // ✅ stop random dalam slice + margin sangat kecil (hampir salah slice)
  const sliceStart = idx * sliceDeg;
  const sliceEnd   = (idx + 1) * sliceDeg;

  let margin = Math.min(sliceDeg * 0.02, 1.5);
  margin = Math.min(margin, sliceDeg / 2 - 0.01);

  const stopTheta =
    (sliceStart + margin) +
    Math.random() * ((sliceEnd - margin) - (sliceStart + margin));

  const startAngle = angle;
  const extraTurns = 3 * 360;

  const base = Math.ceil(startAngle/360) * 360;
  let targetAngle = base + extraTurns + (360 - stopTheta);
  if(targetAngle <= startAngle + 360){
    targetAngle += 360;
  }

  const D = (targetAngle - startAngle);
  const v0 = Math.max(0.15, FREE_SPIN_SPEED_DEG_PER_MS);
  let duration = (2 * D) / v0;

  if(duration < 1600) duration = 1600;
  if(duration > 6500) duration = 6500;

  const a = -v0 / duration;

  let startTime = null;

  function animate(t){
    if(!startTime) startTime = t;
    const elapsed = t - startTime;
    const tt = Math.min(elapsed, duration);

    const current = startAngle + (v0 * tt) + (0.5 * a * tt * tt);

    angle = current;
    wheelEl.style.transform = `rotate(${angle}deg)`;

    if(elapsed < duration){
      rafId = requestAnimationFrame(animate);
    }else{
      rafId = null;
      angle = targetAngle;
      wheelEl.style.transform = `rotate(${angle}deg)`;
      finishSpin(winPrize);
    }
  }

  rafId = requestAnimationFrame(animate);
}

spinBtn.addEventListener("click", ()=>{
  if(spinPhase === "idle"){
    if(spinning) return;
    if(!prizes.length){
      alert("Daftar hadiah kosong. Tambahkan hadiah di Admin Mode dulu.");
      return;
    }

    spinning = true;
    cancelSpinIfAny();

    selectedPrize = pickPrize();
    selectedIndex = prizes.indexOf(selectedPrize);

    startFreeSpin();
    return;
  }

  if(spinPhase === "spinning"){
    stopToSelectedPrize();
    return;
  }

  if(spinPhase === "stopping"){
    return;
  }
});

function finishSpin(winPrize){
  try{
    drum.loop = false;
    drum.pause();
  }catch(e){}
  winSfx.play().catch(()=>{});

  pointerClickTriple();

  winText.classList.remove("win-zoom");
  winText.innerText = winPrize.name.replace("\n"," ");
  overlay.style.display = "flex";
  void winText.offsetWidth;
  winText.classList.add("win-zoom");

  confettiExplode();

  addLog(winPrize.name.replace("\n"," "));

  if(winPrize.once){
    prizes = prizes.filter(p => p !== winPrize);
    draw();
  }

  saveState();

  spinning = false;
  spinPhase = "idle";
  selectedPrize = null;
  selectedIndex = -1;
  spinLastTime = null;

  spinBtn.disabled = false;
  spinBtn.textContent = "SPIN";
}

overlay.addEventListener("click", ()=>{ overlay.style.display = "none"; });

function confettiExplode(){
  const colors = [ "#ffffff", maroon, "#d4af37" ];
  const sx = "50vw";
  const sy = "55vh";
  const count = 260;

  for(let i=0;i<count;i++){
    const c = document.createElement("div");
    c.className = "confetti";
    c.style.setProperty("--sx", sx);
    c.style.setProperty("--sy", sy);
    c.style.setProperty("--c", colors[Math.floor(Math.random()*colors.length)]);

    const a = Math.random() * Math.PI * 2;
    const dist = 120 + Math.random() * 520;
    const dx = Math.cos(a) * dist;
    const dy = Math.sin(a) * dist;

    c.style.setProperty("--dx", dx.toFixed(1) + "px");
    c.style.setProperty("--dy", dy.toFixed(1) + "px");

    const jitterX = (Math.random()*10 - 5);
    const jitterY = (Math.random()*10 - 5);
    c.style.left = `calc(50vw + ${jitterX}px)`;
    c.style.top  = `calc(55vh + ${jitterY}px)`;

    document.body.appendChild(c);
    setTimeout(()=> c.remove(), 3200);
  }
}

const admin = document.getElementById("admin");
const adminList = document.getElementById("adminList");
const adminLogList = document.getElementById("adminLogList");
const closeAdmin = document.getElementById("closeAdmin");

function exportLogToExcel(){
  const header = ["Tanggal & Waktu","Hadiah"];
  const rows = [header];
  const ordered = spinLogs.slice().reverse();

  for(const entry of ordered){
    const parts = String(entry).split(" — ");
    const tanggal = parts[0] || "";
    const hadiah = parts.slice(1).join(" — ") || "";
    rows.push([tanggal, hadiah]);
  }

  function csvEscape(v){
    v = String(v ?? "");
    v = v.replaceAll("\r\n","\n").replaceAll("\r","\n");
    if(v.includes('"')) v = v.replaceAll('"','""');
    if(v.includes(",") || v.includes("\n") || v.includes('"')) v = `"${v}"`;
    return v;
  }

  const csv = rows.map(r => r.map(csvEscape).join(",")).join("\r\n");
  const blob = new Blob(["\uFEFF" + csv], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  const fname = `solushe-spin-log-${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}.csv`;

  const a = document.createElement("a");
  a.href = url;
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(()=> URL.revokeObjectURL(url), 1200);
}

function resetAllToDefault(){
  const ok = confirm("Reset SEMUA data ke setting awal? (log + chance + hadiah once + posisi wheel akan kembali default)");
  if(!ok) return;

  prizes = DEFAULT_PRIZES.map(p => ({...p}));
  spinLogs = [];
  angle = 0;

  wheelEl.style.transform = `rotate(${angle}deg)`;
  draw();
  renderLog();
  renderAdmin();

  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
  saveState();
}

function addLog(text){
  const stamp = new Date().toLocaleString("id-ID");
  spinLogs.unshift(`${stamp} — ${text}`);
  renderLog();
  saveState();
}

function renderLog(){
  if(spinLogs.length===0){
    adminLogList.innerHTML = "<i>Belum ada spin.</i>";
    return;
  }
  adminLogList.innerHTML = spinLogs.map(x => `• ${escapeHtml(x)}`).join("<br>");
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ✅ NEW: AUTO NORMALIZE CHANCE -> TOTAL 100% (ambil dari terbesar dulu) */
function normalizeChancesTo100(fixedIndex){
  if(!Array.isArray(prizes) || prizes.length === 0) return;

  const isIphone = (p)=> String(p?.name || "").toLowerCase().includes("iphone");
  const minChance = (idx)=>{
    const p = prizes[idx];
    if(isIphone(p)) return 0;
    // kalau ada lebih dari 1 hadiah, non-iphone minimal 1%
    return (prizes.length > 1) ? 1 : 0;
  };

  // clamp semua chance dulu
  for(let i=0;i<prizes.length;i++){
    let v = Number(prizes[i].chance || 0);
    if(!isFinite(v)) v = 0;
    v = Math.round(v);
    if(v < minChance(i)) v = minChance(i);
    if(v > 100) v = 100;
    prizes[i].chance = v;
  }

  const sumAll = ()=> prizes.reduce((a,p)=> a + Number(p.chance||0), 0);
  let total = sumAll();

  // kalau sudah pas, selesai
  if(total === 100) return;

  const fixed = (typeof fixedIndex === "number" && fixedIndex >=0 && fixedIndex < prizes.length) ? fixedIndex : null;

  // helper: list donor/receiver indices by chance desc (largest first), exclude fixed when possible
  const sortedByChanceDesc = (excludeIdx)=>{
    const arr = prizes.map((p,i)=>({ i, c:Number(p.chance||0) }));
    return arr
      .filter(x => excludeIdx == null ? true : x.i !== excludeIdx)
      .sort((a,b)=> b.c - a.c);
  };

  // jika total > 100: kurangi dari yang chance terbesar dulu (selain fixed kalau ada)
  if(total > 100){
    let need = total - 100;

    const donors = sortedByChanceDesc(fixed);
    // kalau donors kosong, fallback ke semua
    const donors2 = donors.length ? donors : sortedByChanceDesc(null);

    for(const d of donors2){
      if(need <= 0) break;
      const i = d.i;
      const minV = minChance(i);
      const canTake = Math.max(0, Number(prizes[i].chance||0) - minV);
      if(canTake <= 0) continue;
      const take = Math.min(canTake, need);
      prizes[i].chance = Number(prizes[i].chance||0) - take;
      need -= take;
    }

    return;
  }

  // jika total < 100: tambahkan ke yang chance terbesar dulu (selain fixed kalau ada)
  if(total < 100){
    let add = 100 - total;

    const receivers = sortedByChanceDesc(fixed);
    const receivers2 = receivers.length ? receivers : sortedByChanceDesc(null);

    if(receivers2.length){
      prizes[receivers2[0].i].chance = Number(prizes[receivers2[0].i].chance||0) + add;
    }else if(fixed != null){
      prizes[fixed].chance = Number(prizes[fixed].chance||0) + add;
    }

    return;
  }
}

/* ✅ ADMIN EDITABLE PRIZES (ADD/REMOVE/EDIT NAME/CHANCE/ONCE) + REORDER */
function renderAdmin(){
  adminList.innerHTML = "";

  // Top controls
  const top = document.createElement("div");
  top.className = "adminRow";
  top.style.borderBottom = "1px solid #eee";

  const left = document.createElement("div");
  left.className = "adminName";
  left.textContent = "Edit Hadiah (nama bisa 2 baris pakai Enter)";

  const right = document.createElement("div");
  right.style.display = "flex";
  right.style.gap = "8px";
  right.style.alignItems = "center";

  const addBtn = document.createElement("button");
  addBtn.textContent = "+ Tambah Hadiah";
  addBtn.style.padding = "8px 12px";
  addBtn.style.border = "none";
  addBtn.style.borderRadius = "10px";
  addBtn.style.background = "#2f7d32";
  addBtn.style.color = "white";
  addBtn.style.fontWeight = "bold";
  addBtn.style.cursor = "pointer";

  addBtn.addEventListener("click", ()=>{
    if(spinPhase !== "idle"){
      alert("Tunggu spin selesai dulu sebelum edit hadiah.");
      return;
    }
    prizes.push({ name:"Hadiah Baru", chance:1 });
    normalizeChancesTo100(prizes.length - 1);
    saveState();
    draw();
    renderAdmin();
  });

  right.appendChild(addBtn);
  top.appendChild(left);
  top.appendChild(right);
  adminList.appendChild(top);

  // Prize rows
  prizes.forEach((p,i)=>{
    const row = document.createElement("div");
    row.className = "adminRow";

    const nmWrap = document.createElement("div");
    nmWrap.className = "adminName";
    nmWrap.style.display = "flex";
    nmWrap.style.flexDirection = "column";
    nmWrap.style.gap = "6px";

    const nameInput = document.createElement("textarea");
    nameInput.value = p.name || "";
    nameInput.rows = 2;
    nameInput.style.width = "100%";
    nameInput.style.resize = "vertical";
    nameInput.style.padding = "8px 10px";
    nameInput.style.border = "1px solid #ddd";
    nameInput.style.borderRadius = "10px";
    nameInput.style.fontWeight = "700";
    nameInput.style.fontFamily = "Arial, sans-serif";

    // Info kecil
    const hint = document.createElement("div");
    hint.style.fontSize = "12px";
    hint.style.color = "#777";
    hint.textContent = "Tip: Enter = baris baru (maks 2 baris tampil di wheel)";

    nmWrap.appendChild(nameInput);
    nmWrap.appendChild(hint);

    const controls = document.createElement("div");
    controls.style.display = "flex";
    controls.style.gap = "10px";
    controls.style.alignItems = "center";
    controls.style.flexWrap = "wrap";
    controls.style.justifyContent = "flex-end";

    // ✅ REORDER BUTTONS (UP/DOWN)
    const upBtn = document.createElement("button");
    upBtn.textContent = "↑";
    upBtn.title = "Naik";
    upBtn.style.padding = "8px 10px";
    upBtn.style.border = "none";
    upBtn.style.borderRadius = "10px";
    upBtn.style.background = "#d4af37";
    upBtn.style.color = "#7a1f2b";
    upBtn.style.fontWeight = "bold";
    upBtn.style.cursor = "pointer";
    upBtn.disabled = (i === 0);

    upBtn.addEventListener("click", ()=>{
      if(spinPhase !== "idle"){
        alert("Tunggu spin selesai dulu sebelum reorder hadiah.");
        return;
      }
      if(i <= 0) return;
      const tmp = prizes[i-1];
      prizes[i-1] = prizes[i];
      prizes[i] = tmp;

      saveState();
      draw();
      renderAdmin();
    });

    const downBtn = document.createElement("button");
    downBtn.textContent = "↓";
    downBtn.title = "Turun";
    downBtn.style.padding = "8px 10px";
    downBtn.style.border = "none";
    downBtn.style.borderRadius = "10px";
    downBtn.style.background = "#d4af37";
    downBtn.style.color = "#7a1f2b";
    downBtn.style.fontWeight = "bold";
    downBtn.style.cursor = "pointer";
    downBtn.disabled = (i === prizes.length - 1);

    downBtn.addEventListener("click", ()=>{
      if(spinPhase !== "idle"){
        alert("Tunggu spin selesai dulu sebelum reorder hadiah.");
        return;
      }
      if(i >= prizes.length - 1) return;
      const tmp = prizes[i+1];
      prizes[i+1] = prizes[i];
      prizes[i] = tmp;

      saveState();
      draw();
      renderAdmin();
    });

    // Chance
    const chWrap = document.createElement("div");
    chWrap.className = "adminChance";
    chWrap.innerHTML = `Chance (%): <input type="number" min="0" step="1" value="${Number(p.chance||0)}">`;
    const chanceInput = chWrap.querySelector("input");

    // Once checkbox
    const onceWrap = document.createElement("label");
    onceWrap.style.display = "flex";
    onceWrap.style.alignItems = "center";
    onceWrap.style.gap = "6px";
    onceWrap.style.fontSize = "14px";
    onceWrap.style.userSelect = "none";

    const onceCb = document.createElement("input");
    onceCb.type = "checkbox";
    onceCb.checked = !!p.once;

    const onceTxt = document.createElement("span");
    onceTxt.textContent = "Once";

    onceWrap.appendChild(onceCb);
    onceWrap.appendChild(onceTxt);

    // Delete button
    const delBtn = document.createElement("button");
    delBtn.textContent = "Hapus";
    delBtn.style.padding = "8px 12px";
    delBtn.style.border = "none";
    delBtn.style.borderRadius = "10px";
    delBtn.style.background = "#b71c1c";
    delBtn.style.color = "white";
    delBtn.style.fontWeight = "bold";
    delBtn.style.cursor = "pointer";

    delBtn.addEventListener("click", ()=>{
      if(spinPhase !== "idle"){
        alert("Tunggu spin selesai dulu sebelum hapus hadiah.");
        return;
      }
      const ok = confirm(`Hapus hadiah ini?\n\n"${(p.name||"").replace("\n"," ")}"`);
      if(!ok) return;

      prizes.splice(i,1);

      // kalau habis dihapus, reset selection state biar aman
      selectedPrize = null;
      selectedIndex = -1;

      normalizeChancesTo100();
      saveState();
      draw();
      renderAdmin();
    });

    // Live update handlers
    const applyChangesNameOnce = ()=>{
      if(!prizes[i]) return;

      prizes[i].name = String(nameInput.value || "").trim() || "Hadiah";

      if(onceCb.checked) prizes[i].once = true;
      else delete prizes[i].once;

      saveState();
      draw();
    };

    const applyChangesChance = ()=>{
      if(!prizes[i]) return;

      prizes[i].chance = Number(chanceInput.value || 0);

      // ✅ AUTO NORMALIZE KE 100% (ambil dari terbesar dulu, selain item yang diedit)
      normalizeChancesTo100(i);
      saveState();
      draw();
      renderAdmin(); // refresh supaya angka chance yang kebagi terlihat
    };

    nameInput.addEventListener("input", applyChangesNameOnce);
    onceCb.addEventListener("change", applyChangesNameOnce);

    // ✅ PENTING: chance pakai "change" agar tidak loncat saat mengetik
    chanceInput.addEventListener("change", applyChangesChance);

    controls.appendChild(upBtn);
    controls.appendChild(downBtn);
    controls.appendChild(chWrap);
    controls.appendChild(onceWrap);
    controls.appendChild(delBtn);

    row.appendChild(nmWrap);
    row.appendChild(controls);

    adminList.appendChild(row);
  });

  renderLog();
}

document.addEventListener("keydown", (e)=>{
  if(e.ctrlKey && e.altKey && e.key.toLowerCase()==="a"){
    admin.style.display = (admin.style.display==="flex") ? "none" : "flex";
    if(admin.style.display==="flex") renderAdmin();
    saveState();
  }
});

closeAdmin.addEventListener("click", ()=>{
  admin.style.display = "none";
  saveState();
});

document.getElementById("adminHotspot").addEventListener("click", ()=>{
  admin.style.display = (admin.style.display==="flex") ? "none" : "flex";
  if(admin.style.display==="flex") renderAdmin();
  saveState();
});

document.getElementById("fullscreenHotspot").addEventListener("click", ()=>{
  if (document.fullscreenElement) document.exitFullscreen();
  else document.documentElement.requestFullscreen();
});

document.getElementById("exportLog").addEventListener("click", ()=>{ exportLogToExcel(); });
document.getElementById("resetAll").addEventListener("click", ()=>{ resetAllToDefault(); });

/* render log awal (biar admin panel kalau dibuka langsung ada isinya) */
renderLog();
</script>
</body>
</html>
